/*
 * @file test_dsp_fft.c
 *
 * @brief	User defined adoption of arm_math library for FFT computations
 * @author​	​Ishmael Pelayo
​ ​*​ ​@date​ ​	December 08 2022
​ ​*​ ​@version​ ​1.0
 *
 */

#include <stdio.h>
#include <stdint.h>
#include <assert.h>
#include <dsp_fft.h>
#include <test_dsp_fft.h>

#define NSAMPLES  (512)
#define NPOINTS   (32)
#define SAMPLING_RATE (8192)
#define HARMONIC_1K (155) // Power in dB for the 1000Hz test Signal from MATLAB
#define FUNDAMENTAL_1K (149) // Power in dB of signal's fundamental frequency
#define FFT_LEAKAGE_1K (5)

int test_dsp() {

  /* MATLAB ARRAY GENERATED AS FOLLOWS:
   * %%Time specifications:
   Fs = 8192;                   % samples per second
   dt = 1/Fs;                   % seconds per sample
   StopTime = 0.0625;             % seconds
   t = (0:dt:StopTime-dt)';     % seconds
   %%Sine wave:
   Fc = 1000;                     % hertz
   x = cos(2*pi*Fc*t);
   * */
  uint16_t matlab_1000Hz[NSAMPLES] = {
   27238, 26450, 25276, 24536, 23404, 22504, 21333, 20680, 19191, 18269, 17012, 15974,
   14795, 13640, 12679, 11661, 10681, 10047, 9888, 9760, 9764, 9639, 9695, 9761, 9744,
   9900, 9881, 10046, 10086, 10330, 10361, 10783, 10789, 11242, 11694, 12295, 12755,
   13490, 14124, 14934, 15695, 16436, 17110, 17788, 18427, 19049, 19619, 20094, 20555,
   20973, 21351, 21738, 22155, 22402, 22837, 23158, 23588, 23947, 24957, 25429, 25976,
   26524, 27062, 27643, 28287, 28965, 29648, 30331, 30981, 31694, 32530, 33335, 34273,
   35168, 36073, 37022, 38005, 39029, 39969, 40985, 42014, 43236, 44372, 45435, 46529,
   47595, 48740, 50895, 51827, 52838, 53657, 54532, 55196, 55873, 56427, 56919, 57323,
   57511, 57618, 57517, 57420, 57138, 56754, 56363, 55856, 55202, 54497, 53672, 52953,
   52077, 51297, 50545, 49656, 48882, 48119, 47351, 46075, 45506, 44844, 44269, 43824,
   43332, 43016, 42472, 42141, 41735, 41424, 40925, 40643, 40057, 39642, 39216, 38664,
   38276, 37571, 36970, 36313, 35668, 34845, 34154, 33352, 32430, 31719, 30875, 29978,
   29108, 28301, 27488, 26415, 25604, 24617, 23585, 22620, 21572, 20590, 19467, 18379,
   17309, 16204, 15122, 13986, 12904, 11816, 10864, 10059, 9926, 9860, 9814, 9759,
   9742, 9717, 9806, 9866, 9984, 10160, 10234, 10510, 10612, 10759, 11086, 11465, 12183,
   12812, 13548, 14235, 15043, 15722, 16493, 17177, 17866, 18494, 19048, 19532, 19930,
   20317, 20719, 21135, 21455, 21829, 22109, 22545, 22816, 23242, 24024, 24367, 24876,
   25336, 25833, 26380, 27069, 27662, 28315, 29015, 29648, 30337, 31065, 31953, 32782,
   33642, 34545, 35507, 36437, 37430, 38395, 39616, 40690, 41761, 42945, 43963, 45110,
   46216, 47360, 49534, 50557, 51532, 52627, 53457, 54322, 54996, 55593, 56146, 56686,
   56982, 57239, 57310, 57347, 57095, 56879, 56524, 56127, 55642, 54984, 54329, 53540,
   52813, 51986, 51225, 50361, 49429, 48696, 47955, 47245, 46585, 46008, 45216, 44711,
   44255, 43676, 43274, 42849, 42449, 42077, 41670, 41245, 40906, 40445, 40088, 39629,
   39142, 38613, 38140, 37576, 37105, 36430, 35821, 35074, 34337, 33541, 32794, 31984, 31177,
   30418, 29548, 28842, 27778, 27004, 25998, 24998, 24059, 22954, 21982, 20952, 19777, 18642,
   17523, 16453, 15289, 14232, 13059, 11995, 10949, 9998, 9930, 9847, 9875, 9747, 9769, 9681,
   9758, 9899, 10081, 10210, 10351, 10524, 10636, 10837, 11091, 11659, 12121, 12830, 13438,
   14234, 14917, 15699, 16450, 17116, 17818, 18453, 18989, 19589, 20079, 20507, 20935, 21290,
   21688, 21999, 22378, 22799, 23140, 23859, 24385, 24657, 25183, 25501, 26177, 26566, 27221,
   27923, 28417, 29219, 29832, 30675, 31410, 32218, 33043, 33987, 34884, 35904, 36864, 37800,
   38893, 39980, 41067, 42117, 43229, 44359, 45480, 46559, 47632, 48747, 49801, 50718, 51866,
   52801, 53695, 54461, 55188, 55895, 56426, 56865, 57270, 57553, 57626, 57630, 57472, 57232,
   56873, 56465, 55884, 55335, 54648, 53874, 53035, 52273, 51497, 50702, 49843, 48967, 48234,
   47413, 46820, 46017, 45433, 44832, 44359, 43910, 43475, 43047, 42637, 42374, 41964, 41711,
   41348, 40914, 40527, 39947, 39445, 38918, 38314, 37798, 37108, 36440, 35667, 34912, 34161,
   33323, 32621, 31019, 30161, 29412, 28452, 27599, 26725, 25844, 24839, 23884, 22822, 21844,
   20820, 19829, 18775, 17766, 16580, 15512, 14444, 13365, 12367, 11344, 10452, 10020, 9854,
   9826, 9709, 9811, 9882, 9836, 10079, 10039, 10238, 10465, 10496, 10741, 10931, 11393, 11783,
   12366, 13010, 13706, 14425, 15078, 15844, 16641, 17300, 17928, 18487, 19118, 19595, 20037,
   20499, 20895, 21389, 21784, 22171, 22489, 22850, 23693, 23970, 24376, 24903, 25333, 25863,
   26282, 26827, 27395, 28030, 28688, 29343, 30040, 30757, 31588, 32352, 33161
  };


  // variable to keep track of passed unit_tests
  uint16_t passing_unit_tests = 0;

  // instance of FFT Magnitude array to keep results
  int16_t* fft_mags;
  uint16_t current_bin_idx;

  fft_mags = dsp_fft_mag(matlab_1000Hz, NSAMPLES);

  /*PRINT OUTPUT FROM MATLAB:
   * % Plot the signal versus time:
   figure;
   plot(t,x);
   xlabel('time (in seconds)');
   title('Signal versus Time');
   zoom xon;
   */

  // Convert output to Discrete time instead
  printf("%3s , %10s , %5s\r\n", "index","power","freq");
  for (int i=0; i<NPOINTS; i++) {
    printf("%3d , %10d , %5d\r\n", i, fft_mags[i], i*(SAMPLING_RATE/NPOINTS));
  } 

  // Print out magnitudes and correlate with REAL-VALUED Frequency Data
  for (int i=0; i<32; i++) {
			printf("%d, FFT MAGNITUDE: %d\r\n", i, fft_mags[i]);
		  }

  current_bin_idx = dsp_fft_max_pitch(fft_mags);

  assert(current_bin_idx == 5);
  passing_unit_tests++;
  assert(fft_mags[current_bin_idx] > fft_mags[current_bin_idx + 1]);
  passing_unit_tests++;
  assert(fft_mags[current_bin_idx - 2] == HARMONIC_1K);
  passing_unit_tests++;
  assert(fft_mags[current_bin_idx - 1] == FUNDAMENTAL_1K);
  passing_unit_tests++;
  assert(fft_mags[current_bin_idx] == FFT_LEAKAGE_1K);
  passing_unit_tests++;

  return passing_unit_tests;
}
